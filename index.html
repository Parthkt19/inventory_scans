<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Scan â†’ Quantity â†’ Excel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  
  <!-- ZXing Library -->
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/umd/index.min.js"></script>
  <!-- XLSX Library -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  
  <style>
    body { font-family: Arial, sans-serif; padding: 10px; text-align: center; }
    video { width: 100%; max-width: 400px; border: 1px solid #ccc; margin-bottom: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.5); justify-content:center; align-items:center; }
    .modal-box { background: #fff; padding: 20px; border-radius: 8px; width: 90%; max-width: 300px; text-align:left; }
    input, select { width: 100%; margin-bottom: 10px; padding: 6px; }
    button { padding: 8px 12px; margin: 5px; }
  </style>
</head>
<body>

<h1>ðŸ“· Scan â†’ Quantity â†’ Excel</h1>
<p>Scan barcode, enter quantity/unit, save to Excel.</p>

<video id="video" autoplay muted playsinline></video>
<div class="status" id="status">Status: Idle</div>

<button onclick="startScan()">Start Scan</button>
<button onclick="stopScan()">Stop Scan</button>
<button onclick="exportExcel()">Export Excel</button>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Quantity</th>
      <th>Unit</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<!-- INPUT MODAL -->
<div class="modal" id="inputModal">
  <div class="modal-box">
    <h3>Enter Details</h3>
    <p><strong>Barcode:</strong> <span id="barcodeText"></span></p>

    <label>Quantity *</label>
    <input id="quantityInput" type="number" min="1" placeholder="Enter quantity" inputmode="numeric" />

    <label>Unit *</label>
    <select id="unitInput">
      <option value="">Select unit</option>
      <option value="Inch">Inch</option>
      <option value="Sheets">Sheets</option>
    </select>

    <button onclick="saveEntry()">Save</button>
  </div>
</div>

<script>
const video = document.getElementById("video");
const statusEl = document.getElementById("status");
const tableBody = document.getElementById("tableBody");
const modal = document.getElementById("inputModal");
const barcodeText = document.getElementById("barcodeText");
const quantityInput = document.getElementById("quantityInput");
const unitInput = document.getElementById("unitInput");

let codeReader;
let scanning = false;
let currentBarcode = "";
let scanData = [];

async function startScan() {
  if (scanning) return;
  scanning = true;
  statusEl.textContent = "Status: Scanning...";

  codeReader = new ZXing.BrowserMultiFormatReader();

  try {
    // Get video input devices
    const devices = await navigator.mediaDevices.enumerateDevices();
    let deviceId = null;
    for (let d of devices) {
      if (d.kind === 'videoinput') {
        deviceId = d.deviceId;
        if (d.label.toLowerCase().includes('back')) break; // prefer rear camera
      }
    }

    codeReader.decodeFromVideoDevice(deviceId, video, (result, err) => {
      if (result) {
        stopScan();
        currentBarcode = result.text;
        showModal(currentBarcode);
      }
    });
  } catch (err) {
    console.error("Camera error:", err);
    alert("Could not access camera. Make sure to allow camera permissions.");
    scanning = false;
  }
}

function stopScan() {
  scanning = false;
  if (codeReader) codeReader.reset();
  statusEl.textContent = "Status: Stopped";
}

function showModal(code) {
  barcodeText.textContent = code;
  quantityInput.value = "";
  unitInput.value = "";
  modal.style.display = "flex";
  quantityInput.focus();
}

function saveEntry() {
  const quantity = quantityInput.value.trim();
  const unit = unitInput.value;

  if (!quantity || !unit) {
    alert("Both Quantity and Unit are required");
    return;
  }

  const row = {
    Index: scanData.length + 1,
    Barcode: currentBarcode,
    Quantity: quantity,
    Unit: unit,
    Timestamp: new Date().toLocaleString()
  };

  scanData.push(row);
  appendRow(row);

  modal.style.display = "none";
  startScan(); // resume scanning
}

function appendRow(row) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${row.Index}</td>
    <td>${row.Barcode}</td>
    <td>${row.Quantity}</td>
    <td>${row.Unit}</td>
    <td>${row.Timestamp}</td>
  `;
  tableBody.appendChild(tr);
}

function exportExcel() {
  if (scanData.length === 0) {
    alert("No data to export");
    return;
  }

  const ws = XLSX.utils.json_to_sheet(scanData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Scans");

  const fileName = `scans_${new Date().toISOString().split("T")[0]}.xlsx`;
  XLSX.writeFile(wb, fileName);
}
</script>

</body>
</html>
