<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />

  <!-- iPhone-safe viewport (NO zoom / NO resize) -->
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

  <title>Scan â†’ Quantity â†’ Excel</title>

  <!-- ZXing -->
  <script src="https://unpkg.com/@zxing/library@latest"></script>

  <!-- SheetJS -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

  <!-- PWA Manifest (INLINE) -->
  <link rel="manifest"
        href='data:application/json,{
          "name":"Scan to Excel",
          "short_name":"ScanExcel",
          "start_url":".",
          "display":"standalone",
          "background_color":"#f4f6f8",
          "theme_color":"#2563eb",
          "icons":[
            {"src":"https://cdn-icons-png.flaticon.com/512/2920/2920244.png","sizes":"192x192","type":"image/png"},
            {"src":"https://cdn-icons-png.flaticon.com/512/2920/2920244.png","sizes":"512x512","type":"image/png"}
          ]
        }'>

  <style>
    /* ---- GLOBAL iPhone LOCK ---- */
    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      overflow-x: hidden;
      font-family: Arial, sans-serif;
      background: #f4f6f8;
      touch-action: manipulation;
    }

    body {
      padding: 16px;
    }

    h1 {
      margin: 8px 0;
    }

    /* ---- CAMERA ---- */
    video {
      width: 100%;
      max-width: 420px;
      height: 170px; /* reduced height */
      object-fit: cover;
      border-radius: 10px;
      border: 2px solid #ccc;
    }

    /* ---- BUTTONS ---- */
    button {
      padding: 10px 16px;
      font-size: 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-right: 6px;
    }

    .start { background: #2563eb; color: #fff; }
    .stop { background: #ef4444; color: #fff; }
    .export { background: #16a34a; color: #fff; }

    .status {
      margin-top: 10px;
      font-size: 14px;
    }

    /* ---- TABLE ---- */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      background: white;
    }

    th, td {
      border: 1px solid #ddd;
      padding: 8px;
      font-size: 13px;
    }

    th {
      background: #f1f5f9;
    }

    /* ---- MODAL ---- */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: none;
      align-items: center;
      justify-content: center;
    }

    .modal-box {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 340px;
    }

    .modal-box h3 {
      margin-top: 0;
    }

    .modal-box label {
      font-size: 13px;
      font-weight: bold;
    }

    .modal-box input,
    .modal-box select {
      font-size: 16px; /* CRITICAL: prevents iOS zoom */
      padding: 8px;
      margin: 6px 0 12px;
    }

    /* Quantity width reduced */
    .quantity-field {
      width: 80%;
    }

    .modal-box select {
      width: 100%;
    }
  </style>
</head>

<body>

<h1>ðŸ“· Scan â†’ Quantity â†’ Excel</h1>
<p>Scan barcode, enter quantity and unit, export locally.</p>

<video id="video" autoplay muted playsinline></video>

<br><br>

<button class="start" onclick="startScan()">Start Scan</button>
<button class="stop" onclick="stopScan()">Stop Scan</button>
<button class="export" onclick="exportExcel()">Export Excel</button>

<div class="status" id="status">Status: Idle</div>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Barcode</th>
      <th>Quantity</th>
      <th>Unit</th>
      <th>Timestamp</th>
    </tr>
  </thead>
  <tbody id="tableBody"></tbody>
</table>

<!-- INPUT MODAL -->
<div class="modal" id="inputModal">
  <div class="modal-box">
    <h3>Enter Details</h3>

    <p><strong>Barcode:</strong> <span id="barcodeText"></span></p>

    <label>Quantity *</label>
    <input id="quantityInput"
           class="quantity-field"
           type="number"
           inputmode="numeric"
           pattern="[0-9]*"
           min="1"
           placeholder="Quantity" />

    <label>Unit *</label>
    <select id="unitInput">
      <option value="">Select unit</option>
      <option value="Inch">Inch</option>
      <option value="Sheets">Sheets</option>
    </select>

    <button class="start" onclick="saveEntry()">Save</button>
  </div>
</div>

<script>
  /* ---- BARCODE LOGIC ---- */
  const video = document.getElementById("video");
  const statusEl = document.getElementById("status");
  const tableBody = document.getElementById("tableBody");
  const modal = document.getElementById("inputModal");
  const barcodeText = document.getElementById("barcodeText");
  const quantityInput = document.getElementById("quantityInput");
  const unitInput = document.getElementById("unitInput");

  const codeReader = new ZXing.BrowserMultiFormatReader();
  let scanData = [];
  let scanning = false;
  let currentBarcode = "";

  function startScan() {
    if (scanning) return;
    scanning = true;
    statusEl.textContent = "Status: Scanning...";

    codeReader.decodeFromVideoDevice(null, video, (result) => {
      if (result) {
        stopScan();
        currentBarcode = result.text;
        showModal();
      }
    });
  }

  function stopScan() {
    scanning = false;
    codeReader.reset();
    statusEl.textContent = "Status: Stopped";
  }

  function showModal() {
    barcodeText.textContent = currentBarcode;
    quantityInput.value = "";
    unitInput.value = "";
    modal.style.display = "flex";
    setTimeout(() => quantityInput.focus(), 300);
  }

  function saveEntry() {
    const qty = quantityInput.value.trim();
    const unit = unitInput.value;

    if (!qty || !unit) {
      alert("Quantity and Unit are required");
      return;
    }

    const row = {
      Index: scanData.length + 1,
      Barcode: currentBarcode,
      Quantity: qty,
      Unit: unit,
      Timestamp: new Date().toLocaleString()
    };

    scanData.push(row);
    appendRow(row);

    modal.style.display = "none";
    startScan();
  }

  function appendRow(row) {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${row.Index}</td>
      <td>${row.Barcode}</td>
      <td>${row.Quantity}</td>
      <td>${row.Unit}</td>
      <td>${row.Timestamp}</td>
    `;
    tableBody.appendChild(tr);
  }

  function exportExcel() {
    if (!scanData.length) {
      alert("No data to export");
      return;
    }

    const ws = XLSX.utils.json_to_sheet(scanData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Scans");

    XLSX.writeFile(wb, `scans_${new Date().toISOString().split("T")[0]}.xlsx`);
  }

  /* ---- INLINE SERVICE WORKER (PWA) ---- */
  if ("serviceWorker" in navigator) {
    const swCode = `
      self.addEventListener('install', e => self.skipWaiting());
      self.addEventListener('fetch', e => {});
    `;
    const blob = new Blob([swCode], { type: "text/javascript" });
    navigator.serviceWorker.register(URL.createObjectURL(blob));
  }
</script>

</body>
</html>
